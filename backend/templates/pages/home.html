<div class="row g-4 p-4">
    <!-- Left Column - Main Content -->
    <div class="col-lg-9">
        <!-- System Overview Widgets -->
        <div class="row g-3 mb-4">
            <div class="col">
                <div class="bg-very-dark text-center p-4 d-flex flex-column justify-content-center" style="height: 120px;">
                    <i class="bi bi-hdd-network text-success mb-2" style="font-size: 1.8rem;"></i>
                    <small class="text-muted d-block">Network Range</small>
                    <div class="fw-bold text-success" id="network-range" style="font-size: 1.3rem;">Loading...</div>
                </div>
            </div>
            <div class="col">
                <div class="bg-very-dark text-center p-4 d-flex flex-column justify-content-center" style="height: 120px;">
                    <i class="bi bi-globe text-success mb-2" style="font-size: 1.8rem;"></i>
                    <small class="text-muted d-block">Public IP</small>
                    <div class="fw-bold text-success" id="public-ip" style="font-size: 1.3rem;">Loading...</div>
                </div>
            </div>
            <div class="col">
                <div class="bg-very-dark text-center p-4 d-flex flex-column justify-content-center" style="height: 120px;">
                    <i class="bi bi-router text-success mb-2" style="font-size: 1.8rem;"></i>
                    <small class="text-muted d-block">Devices Found</small>
                    <div class="fw-bold text-success" id="devices-found" style="font-size: 1.3rem;">0</div>
                </div>
            </div>
            <div class="col">
                <div class="bg-very-dark text-center p-4 d-flex flex-column justify-content-center" style="height: 120px;">
                    <i class="bi bi-wifi text-success mb-2" style="font-size: 1.8rem;"></i>
                    <small class="text-muted d-block">Online</small>
                    <div class="fw-bold text-success" id="devices-online" style="font-size: 1.3rem;">0</div>
                </div>
            </div>
            <div class="col">
                <div class="bg-very-dark text-center p-4 d-flex flex-column justify-content-center" style="height: 120px;">
                    <i class="bi bi-pie-chart text-success mb-2" style="font-size: 1.8rem;"></i>
                    <small class="text-muted d-block">Saturation</small>
                    <div class="fw-bold text-success" id="network-saturation" style="font-size: 1.3rem;">0%</div>
                </div>
            </div>
        </div>
        
        <!-- Network Map -->
        <div class="network-map-container mb-4 p0 sticky-top">
            <div id="network-map" hx-get="/api/network-map" hx-trigger="load, every 8s" hx-swap="innerHTML">
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Network Devices Cards -->
        <div class="mb-4">
            <h5 class="section-header">NETWORK DEVICES</h5>
            <div id="devices-container" hx-get="/api/devices" hx-trigger="load, every 10s" hx-swap="innerHTML">
                <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading devices...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Scan Control & Event Logs -->
    <div class="col-lg-3">
        <!-- Scan Control Panel -->
        <div class="mb-4">
            <div hx-get="/api/scan/control" 
                 hx-trigger="load" 
                 hx-swap="innerHTML">
                <div class="bg-very-dark p-4 d-flex align-items-center justify-content-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading scan control...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Event Logs Section -->
        <div class="">
            <div class="p-0" style="max-height: 600px; overflow-y: auto;">
                <div id="event-logs" hx-get="/api/event-logs" hx-trigger="load, every 4s" hx-swap="innerHTML">
                    <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-success">
            <div id="device-modal-content">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

<script>
    // View mode toggle
    document.addEventListener('change', function(event) {
        if (event.target.name === 'view-mode') {
            const viewMode = event.target.id.includes('grid') ? 'grid' : 'list';
            const devicesContainer = document.getElementById('devices-container');
            const listContainer = document.getElementById('device-list-container');
            
            console.log('View mode changed to:', viewMode);
            console.log('Devices container:', devicesContainer);
            console.log('List container:', listContainer);
            
            if (viewMode === 'grid') {
                // Show grid view, hide list view
                if (devicesContainer) devicesContainer.style.display = 'block';
                if (listContainer) listContainer.style.display = 'none';
                htmx.ajax('GET', '/api/devices', { target: '#devices-container' });
            } else {
                // Show list view, hide grid view
                if (devicesContainer) devicesContainer.style.display = 'none';
                if (listContainer) listContainer.style.display = 'block';
                htmx.ajax('GET', '/api/device-list', { target: '#device-list-container' });
            }
        }
    });

    // Device modal handling
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.target.id === 'device-modal-content') {
            const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
            modal.show();
        }
    });

    // Update system status data
    function updateSystemStatus() {
        fetch('/api/system-status')
            .then(response => response.text())
            .then(html => {
                // Parse the HTML to extract data
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extract network range and public IP from the original system status response
                const systemInfoDivs = doc.querySelectorAll('.system-info');
                
                let networkRange = '';
                if (systemInfoDivs.length >= 2) {
                    // Network range
                    const networkRangeEl = systemInfoDivs[0].querySelector('.fw-bold');
                    if (networkRangeEl) {
                        networkRange = networkRangeEl.textContent;
                        document.getElementById('network-range').textContent = networkRange;
                    }
                    
                    // Public IP
                    const publicIP = systemInfoDivs[1].querySelector('.fw-bold');
                    if (publicIP) {
                        document.getElementById('public-ip').textContent = publicIP.textContent;
                    }
                }
                
                // Extract device counts and calculate saturation
                let devicesFound = 0;
                let devicesOnline = 0;
                
                const deviceStats = doc.querySelectorAll('.small .d-flex');
                deviceStats.forEach(stat => {
                    const label = stat.querySelector('.text-muted');
                    const value = stat.querySelector('.text-success');
                    
                    if (label && value) {
                        if (label.textContent.includes('Devices Found')) {
                            devicesFound = parseInt(value.textContent) || 0;
                            document.getElementById('devices-found').textContent = value.textContent;
                        } else if (label.textContent.includes('Online')) {
                            devicesOnline = parseInt(value.textContent) || 0;
                            document.getElementById('devices-online').textContent = value.textContent;
                        }
                    }
                });
                
                // Calculate network saturation (online devices / total possible addresses)
                if (networkRange.includes('/24')) {
                    // /24 network has 254 usable addresses (256 - 2 for network and broadcast)
                    const totalAddresses = 254;
                    const saturation = ((devicesOnline / totalAddresses) * 100).toFixed(1);
                    document.getElementById('network-saturation').textContent = saturation + '%';
                } else if (networkRange.includes('/')) {
                    // Extract CIDR and calculate total addresses
                    const cidr = parseInt(networkRange.split('/')[1]);
                    const totalAddresses = Math.pow(2, 32 - cidr) - 2; // Subtract network and broadcast
                    const saturation = ((devicesOnline / totalAddresses) * 100).toFixed(1);
                    document.getElementById('network-saturation').textContent = saturation + '%';
                } else {
                    document.getElementById('network-saturation').textContent = '0%';
                }
            })
            .catch(error => console.error('Error updating system status:', error));
    }

    // Update system status on load and every 3 seconds
    updateSystemStatus();
    setInterval(updateSystemStatus, 3000);
</script>